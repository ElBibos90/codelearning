
> codelearning@1.0.0 test
> node --experimental-vm-modules node_modules/jest/bin/jest.js --no-cache tests/services/LessonService.test.js

(node:19956) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/services/LessonService.test.js
  Test Environment
    ‚àö should have correct test environment variables (3 ms)
    ‚àö should mock console.error and console.warn (2 ms)
  LessonService
    Lesson Creation
      ‚àö should create lesson with template (3 ms)
      ‚àö should fail with invalid data (4 ms)
      ‚àö should create lesson with custom content (3 ms)
    Lesson Update and Versioning
      ‚àö should update lesson and create new version (3 ms)
      ‚àö should get lesson versions (3 ms)
      ‚àö should revert to previous version (6 ms)
    Progress Tracking
      ‚àö should mark lesson as completed (4 ms)
      ‚àö should get progress status (2 ms)
      ‚àö should update last accessed timestamp (117 ms)
    Lesson Ordering
      √ó should reorder lessons (6 ms)
    Content Sanitization
      √ó should sanitize HTML content (1 ms)
      ‚àö should preserve markdown content (2 ms)

  ‚óè LessonService ‚Ä∫ Lesson Ordering ‚Ä∫ should reorder lessons

    expect(received).toHaveLength(expected)

    Expected length: 2
    Received length: 4
    Received array:  [{"id": 155, "order_number": 1}, {"id": 152, "order_number": 4}, {"id": 153, "order_number": 1002}, {"id": 154, "order_number": 1003}]

    [0m [90m 238 |[39m             [36mconst[39m updatedOrder [33m=[39m [36mawait[39m [33mLessonService[39m[33m.[39mreorderLessons(testCourse[33m.[39mid[33m,[39m orderUpdates)[33m;[39m
     [90m 239 |[39m     
    [31m[1m>[22m[39m[90m 240 |[39m             expect(updatedOrder)[33m.[39mtoHaveLength([35m2[39m)[33m;[39m
     [90m     |[39m                                  [31m[1m^[22m[39m
     [90m 241 |[39m             expect(updatedOrder[[35m0[39m][33m.[39mid)[33m.[39mtoBe(lesson2[33m.[39mid)[33m;[39m
     [90m 242 |[39m             expect(updatedOrder[[35m0[39m][33m.[39morder_number)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m 243 |[39m             expect(updatedOrder[[35m1[39m][33m.[39mid)[33m.[39mtoBe(testLesson[33m.[39mid)[33m;[39m[0m

      at Object.<anonymous> (tests/services/LessonService.test.js:240:34)

  ‚óè LessonService ‚Ä∫ Content Sanitization ‚Ä∫ should sanitize HTML content

    expect(received).not.toContain(expected) // indexOf

    Expected substring: not "<script>"
    Received string:        "<p>Safe content</p><script>alert(\"unsafe\")</script>"

    [0m [90m 282 |[39m             [36mconst[39m lesson [33m=[39m lessonResult[33m.[39mrows[[35m0[39m][33m;[39m
     [90m 283 |[39m             expect(lesson[33m.[39mcontent)[33m.[39mtoContain([32m'<p>Safe content</p>'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 284 |[39m             expect(lesson[33m.[39mcontent)[33m.[39mnot[33m.[39mtoContain([32m'<script>'[39m)[33m;[39m
     [90m     |[39m                                        [31m[1m^[22m[39m
     [90m 285 |[39m         })[33m;[39m
     [90m 286 |[39m
     [90m 287 |[39m         test([32m'should preserve markdown content'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (tests/services/LessonService.test.js:284:40)

Test Suites: 1 failed, 1 total
Tests:       2 failed, 12 passed, 14 total
Snapshots:   0 total
Time:        1.277 s
Ran all test suites matching /tests\\services\\LessonService.test.js/i.
